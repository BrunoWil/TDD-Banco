<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simula√ß√£o Banc√°ria: Tradicional vs TDD</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #f4f4f9;
            --card-bg: #ffffff;
            --primary: #3498db;
            --danger: #e74c3c;
            --success: #2ecc71;
            --text: #2c3e50;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 30px; }
        
        .nav-bar { text-align: center; margin-bottom: 30px; }
        .nav-link { text-decoration: none; padding: 12px 25px; border-radius: 4px; font-weight: bold; margin: 0 10px; transition: 0.3s; }
        .nav-link.active { background-color: var(--primary); color: white; box-shadow: 0 4px 6px rgba(52, 152, 219, 0.3); }
        .nav-link.inactive { background-color: #bdc3c7; color: white; }
        .nav-link.inactive:hover { background-color: #95a5a6; }

        .controls { background: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .scenarios { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        button { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-scenario { background-color: var(--primary); color: white; }
        .btn-scenario:hover { background-color: #2980b9; }
        .btn-run { background-color: var(--success); color: white; width: 100%; font-size: 1.1em; margin-top: 10px; }
        .btn-run:hover { background-color: #27ae60; }
        
        .results-container { display: flex; gap: 20px; flex-wrap: wrap; }
        .result-card { flex: 1; background: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); min-width: 300px; }
        .result-header { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #eee; }
        .tradicional { border-top: 5px solid var(--danger); }
        .tdd { border-top: 5px solid var(--success); }
        
        .metric { display: flex; justify-content: space-between; margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-radius: 4px; }
        .metric label { font-weight: bold; color: #7f8c8d; }
        .metric span { font-family: 'Consolas', monospace; }
        
        .log { margin-top: 15px; max-height: 300px; overflow-y: auto; font-size: 0.9em; }
        .log-item { padding: 5px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .log-item.fail { color: var(--danger); }
        .log-item.success { color: var(--success); }

        .highlight-error { background-color: #fadbd8; color: #c0392b; font-weight: bold; padding: 2px 5px; border-radius: 3px; }
        .highlight-success { background-color: #d5f5e3; color: #1e8449; font-weight: bold; padding: 2px 5px; border-radius: 3px; }

        input[type="number"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 100px; }
    </style>
</head>
<body>

<div class="container">
    <div class="nav-bar">
        <a href="index.html" class="nav-link active">Simula√ß√£o Unit√°ria</a>
        <a href="mass_tests.html" class="nav-link inactive">Relat√≥rio Massivo</a>
    </div>

    <h1>Simulador: Impacto do TDD em Sistemas Banc√°rios</h1>

    <div class="controls" style="border-left: 5px solid var(--primary);">
        <h3 style="margin-top: 0; cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="toggleStructure()">
            <span>üìÇ Entenda a Estrutura do C√≥digo (Passo a Passo)</span>
            <span id="toggleIcon" style="font-size: 0.8em;">‚ñº</span>
        </h3>
        <div id="structureContent" style="display: none; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
            <p>O sistema compara duas implementa√ß√µes de uma conta banc√°ria para demonstrar a efic√°cia do TDD:</p>
            
            <!-- Fluxo Visual TDD -->
            <div style="display: flex; justify-content: center; align-items: center; margin: 25px 0; gap: 15px; flex-wrap: wrap; background: #fff; padding: 15px; border-radius: 8px; border: 1px dashed #ccc;">
                <div style="text-align: center; width: 110px;">
                    <div style="width: 70px; height: 70px; background-color: #e74c3c; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin: 0 auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 3px solid #c0392b;">RED</div>
                    <div style="font-size: 0.85em; margin-top: 8px; font-weight: bold; color: #c0392b;">1. Escrever Teste<br>(Falha)</div>
                </div>
                <div style="font-size: 1.5em; color: #95a5a6;">‚ûú</div>
                <div style="text-align: center; width: 110px;">
                    <div style="width: 70px; height: 70px; background-color: #2ecc71; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin: 0 auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 3px solid #27ae60;">GREEN</div>
                    <div style="font-size: 0.85em; margin-top: 8px; font-weight: bold; color: #27ae60;">2. C√≥digo M√≠nimo<br>(Passa)</div>
                </div>
                <div style="font-size: 1.5em; color: #95a5a6;">‚ûú</div>
                <div style="text-align: center; width: 110px;">
                    <div style="width: 70px; height: 70px; background-color: #3498db; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8em; margin: 0 auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 3px solid #2980b9;">REFACTOR</div>
                    <div style="font-size: 0.85em; margin-top: 8px; font-weight: bold; color: #2980b9;">3. Melhorar<br>(Limpeza)</div>
                </div>
            </div>

            <!-- Exemplo de C√≥digo -->
            <div style="margin: 20px 0; background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 8px; font-family: 'Consolas', monospace; font-size: 0.9em;">
                <div style="margin-bottom: 10px; border-bottom: 1px solid #34495e; padding-bottom: 5px; font-weight: bold; color: #f1c40f;">
                    üíª Exemplo Real do Projeto: Corre√ß√£o de Precis√£o (Float vs Decimal)
                </div>
                
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 250px;">
                        <div style="color: #e74c3c; margin-bottom: 5px; font-weight: bold;">1. RED (O Teste que Falha)</div>
                        <div style="background: #1a252f; padding: 10px; border-radius: 4px; overflow-x: auto; white-space: pre;">def test_precision():
    acc = Account(1.10)
    acc.withdraw(0.40)
    
    # Float: 0.7000000000000001
    assert acc.balance == 0.70</div>
                    </div>
                    
                    <div style="flex: 1; min-width: 250px;">
                        <div style="color: #3498db; margin-bottom: 5px; font-weight: bold;">3. REFACTOR (Solu√ß√£o TDD)</div>
                        <div style="background: #1a252f; padding: 10px; border-radius: 4px; overflow-x: auto; white-space: pre;">from decimal import Decimal

class Account:
    def __init__(self, val):
        # Decimal garante exatid√£o
        self.balance = Decimal(str(val))</div>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 300px;">
                    <h4 style="color: var(--danger); margin-bottom: 5px;">üî¥ 1. Implementa√ß√£o Tradicional</h4>
                    <p style="margin-top: 0; font-size: 0.9em; color: #666;"><em>Arquivo: <code>traditional/main.py</code></em></p>
                    <ul style="font-size: 0.9em;">
                        <li><strong>Tipo de Dado:</strong> Usa <code>float</code>. Gera erros de arredondamento (ex: 0.1 + 0.2 ‚â† 0.3).</li>
                        <li><strong>L√≥gica:</strong> Valida√ß√µes fr√°geis. Permite falhas como saldo negativo ou estouro de limite de saques.</li>
                    </ul>
                </div>
                
                <div style="flex: 1; min-width: 300px;">
                    <h4 style="color: var(--success); margin-bottom: 5px;">üü¢ 2. Implementa√ß√£o TDD</h4>
                    <p style="margin-top: 0; font-size: 0.9em; color: #666;"><em>Arquivo: <code>tdd/main_tdd.py</code></em></p>
                    <ul style="font-size: 0.9em;">
                        <li><strong>Tipo de Dado:</strong> Usa <code>Decimal</code>. Garante precis√£o monet√°ria absoluta.</li>
                        <li><strong>Seguran√ßa:</strong> Protegida por 32 testes unit√°rios (<code>tdd/test_tdd_exaustivo.py</code>).</li>
                    </ul>
                </div>
            </div>

            <div style="margin-top: 15px; background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 0.9em; border: 1px solid #eee;">
                <strong>‚öôÔ∏è Fluxo da Simula√ß√£o:</strong> O Frontend envia os dados para a API (<code>api.py</code>), que executa o cen√°rio em ambas as classes via <code>services.py</code> e retorna a compara√ß√£o.
            </div>
        </div>
    </div>

    <div class="controls">
        <h3>Configura√ß√£o da Simula√ß√£o</h3>
        
        <div style="margin-bottom: 15px;">
            <label for="testSelect"><strong>Selecione um Caso de Teste (TDD Exaustivo):</strong></label>
            <select id="testSelect" onchange="loadTestScenario()" style="width: 100%; padding: 10px; margin-top: 5px; border-radius: 4px; border: 1px solid #ccc;">
                <option value="">-- Escolha um teste --</option>
            </select>
        </div>
        
        <!-- Painel de Contexto TDD Adicionado -->
        <div id="testDescription" style="background: #e8f6f3; padding: 15px; border-left: 5px solid #1abc9c; margin-bottom: 15px; display: none; border-radius: 4px;">
            <h4 style="margin-top: 0; color: #16a085; margin-bottom: 5px;">Contexto TDD (Ciclo Red-Green-Refactor)</h4>
            <p id="testDescText" style="margin: 0; line-height: 1.4; font-size: 0.95em; color: #34495e;"></p>
        </div>
        
        <div style="margin-top: 15px; display: flex; gap: 20px; flex-wrap: wrap;">
            <div><label>Saldo Inicial: </label>
            <input type="number" id="initialBalance" value="0.00" step="0.01"></div>
            <div><label>Limite Valor: </label>
            <input type="number" id="limitValue" value="500.00"></div>
            <div><label>Limite Saques: </label>
            <input type="number" id="limitQty" value="3"></div>
        </div>
        
        <div id="operationsList" style="margin-top: 15px;">
            <!-- Lista de opera√ß√µes din√¢mica -->
        </div>

        <button class="btn-run" onclick="runSimulation()">Executar Simula√ß√£o Comparativa</button>
    </div>

    <div class="results-container">
        <!-- Resultado Tradicional -->
        <div class="result-card tradicional">
            <div class="result-header" style="color: var(--danger)">M√©todo Tradicional (Sem TDD)</div>
            <div class="metric">
                <label>Saldo Final:</label>
                <span id="tradBalance">---</span>
            </div>
            <div class="metric">
                <label>Tipo de Dado:</label>
                <span id="tradType">---</span>
            </div>
            <div class="log" id="tradLog"></div>
        </div>

        <!-- Resultado TDD -->
        <div class="result-card tdd">
            <div class="result-header" style="color: var(--success)">M√©todo TDD (Refatorado)</div>
            <div class="metric">
                <label>Saldo Final:</label>
                <span id="tddBalance">---</span>
            </div>
            <div class="metric">
                <label>Tipo de Dado:</label>
                <span id="tddType">---</span>
            </div>
            <div class="log" id="tddLog"></div>
        </div>
    </div>

    <div class="controls" style="margin-top: 20px;">
        <h3>Visualiza√ß√£o Gr√°fica da Discrep√¢ncia</h3>
        <div style="position: relative; height: 300px; width: 100%;">
            <canvas id="balanceChart"></canvas>
        </div>
    </div>

</div>

<script>
    let operations = [];
    let chartInstance = null;
    const API_BASE_URL = 'http://127.0.0.1:8000'; // Altere para o IP de produ√ß√£o ou deixe vazio '' se estiver no mesmo dom√≠nio

    // Mapeamento dos 32 testes do arquivo test_tdd_exaustivo.py
    const testCases = [
        // Grupo 1: Inicializa√ß√£o
        { id: 't01', name: '01. Inicializa√ß√£o: Saldo Zero', bal: 0, lim: 500, limQ: 3, ops: [], desc: "Setup/Fixture: Garante que o objeto Account √© instanciado corretamente com o estado inicial esperado (Zero) antes de qualquer opera√ß√£o." },
        { id: 't02', name: '02. Inicializa√ß√£o: Saldo Float (100.50)', bal: 100.50, lim: 500, limQ: 3, ops: [], desc: "Setup/Fixture: Verifica se o construtor aceita e converte corretamente tipos primitivos (float) para a representa√ß√£o interna segura." },
        { id: 't03', name: '03. Inicializa√ß√£o: Limites Padr√£o', bal: 0, lim: 500, limQ: 3, ops: [], desc: "Setup: Valida√ß√£o de valores default definidos nas regras de neg√≥cio." },
        { id: 't04', name: '04. Inicializa√ß√£o: Limites Custom (1000/5)', bal: 0, lim: 1000, limQ: 5, ops: [], desc: "Setup: Garante flexibilidade da classe para diferentes perfis de conta (inje√ß√£o de depend√™ncia via construtor)." },
        { id: 't05', name: '05. Atributos Cliente (Visual)', bal: 0, lim: 500, limQ: 3, ops: [], desc: "Verifica√ß√£o de integridade de dados n√£o-monet√°rios." },
        
        // Grupo 2: Dep√≥sitos
        { id: 't06', name: '06. Dep√≥sito: Valor Positivo (100)', bal: 0, lim: 500, limQ: 3, ops: [{tipo: 'deposito', valor: 100}], desc: "State Verification: Verifica se o m√©todo deposit() altera o estado do saldo corretamente. No TDD, come√ßamos com a implementa√ß√£o mais simples (Green)." },
        { id: 't07', name: '07. Dep√≥sito: String/Float (50.50)', bal: 0, lim: 500, limQ: 3, ops: [{tipo: 'deposito', valor: 50.50}], desc: "Robustez de Tipos: Garante que o sistema aceita diferentes formatos num√©ricos sem quebrar." },
        { id: 't08', name: '08. Dep√≥sito: Valor Zero', bal: 0, lim: 500, limQ: 3, ops: [{tipo: 'deposito', valor: 0}], desc: "Guard Assertion: Regra de neg√≥cio que impede movimenta√ß√µes nulas." },
        { id: 't09', name: '09. Dep√≥sito: Valor Negativo', bal: 0, lim: 500, limQ: 3, ops: [{tipo: 'deposito', valor: -50}], desc: "Guard Assertion: Valida√ß√£o cr√≠tica para impedir inje√ß√£o de valores negativos (que virariam saques disfar√ßados)." },
        { id: 't10', name: '10. Dep√≥sito: M√∫ltiplos (10, 20, 30)', bal: 0, lim: 500, limQ: 3, ops: [{tipo: 'deposito', valor: 10}, {tipo: 'deposito', valor: 20}, {tipo: 'deposito', valor: 30}], desc: "Acumula√ß√£o de Estado: Verifica se m√∫ltiplas opera√ß√µes sequenciais mant√™m a consist√™ncia do saldo." },
        { id: 't11', name: '11. Dep√≥sito: Centavos (0.01)', bal: 0, lim: 500, limQ: 3, ops: [{tipo: 'deposito', valor: 0.01}], desc: "Precis√£o B√°sica: Verifica se o sistema consegue lidar com a menor unidade monet√°ria poss√≠vel." },
        
        // Grupo 3: Saques B√°sicos
        { id: 't12', name: '12. Saque: Saldo Suficiente (100)', bal: 1000, lim: 500, limQ: 3, ops: [{tipo: 'saque', valor: 100}], desc: "Ciclo 1 (L√≥gica B√°sica): O teste define o 'Caminho Feliz' do saque. A implementa√ß√£o inicial (Green) apenas subtrai o valor." },
        { id: 't13', name: '13. Saque: Total (Zerar Conta)', bal: 1000, lim: 2000, limQ: 3, ops: [{tipo: 'saque', valor: 1000}], desc: "Teste de Limite: Verifica o comportamento exato quando Saldo == Saque." },
        { id: 't14', name: '14. Saque: Insuficiente (Guard Assertion)', bal: 1000, lim: 2000, limQ: 3, ops: [{tipo: 'saque', valor: 1001}], desc: "Ciclo 2 (Guard Assertion): Este teste for√ßa a falha (Red) quando o saldo √© insuficiente. A corre√ß√£o (Green) exige adicionar um 'if' para lan√ßar exce√ß√£o." },
        { id: 't15', name: '15. Saque: Valor Zero', bal: 1000, lim: 500, limQ: 3, ops: [{tipo: 'saque', valor: 0}], desc: "Valida√ß√£o de Entrada: Impede opera√ß√µes nulas desnecess√°rias." },
        { id: 't16', name: '16. Saque: Valor Negativo', bal: 1000, lim: 500, limQ: 3, ops: [{tipo: 'saque', valor: -100}], desc: "Seguran√ßa: Impede que um saque negativo se torne um dep√≥sito indevido." },
        { id: 't17', name: '17. Saque: Acima Limite Transa√ß√£o (600)', bal: 1000, lim: 500, limQ: 3, ops: [{tipo: 'saque', valor: 600}], desc: "Regra de Neg√≥cio: Valida√ß√£o de limite por opera√ß√£o, independente do saldo dispon√≠vel." },
        
        // Grupo 4: Precis√£o Num√©rica
        { id: 't18', name: '18. Precis√£o: Soma (0.1+0.1+0.1)', bal: 0, lim: 500, limQ: 3, ops: [{tipo: 'deposito', valor: 0.1}, {tipo: 'deposito', valor: 0.1}, {tipo: 'deposito', valor: 0.1}], desc: "Ciclo 3 (Precis√£o - Refactor): Exp√µe o erro cl√°ssico de ponto flutuante (0.30000000000000004). Exige refatora√ß√£o para Decimal." },
        { id: 't19', name: '19. Precis√£o: Subtra√ß√£o (1.10 - 0.40)', bal: 1.10, lim: 500, limQ: 3, ops: [{tipo: 'saque', valor: 0.40}], desc: "Ciclo 3 (Precis√£o - Refactor): Verifica erro de subtra√ß√£o em float. Essencial para garantir integridade de saldo." },
        { id: 't20', name: '20. Precis√£o: Multiplica√ß√£o (100x 0.01)', bal: 0, lim: 500, limQ: 3, ops: Array(100).fill({tipo: 'deposito', valor: 0.01}), desc: "Teste de Carga/Acumula√ß√£o: Verifica se pequenos erros de precis√£o se acumulam ao longo de muitas transa√ß√µes." },
        { id: 't21', name: '21. Arredondamento Entrada (10.555)', bal: 0, lim: 500, limQ: 3, ops: [{tipo: 'deposito', valor: 10.555}], desc: "Pol√≠tica de Arredondamento: Define como o sistema lida com fra√ß√µes de centavos (ROUND_HALF_UP)." },
        { id: 't22', name: '22. Arredondamento Saque (10.555)', bal: 1000, lim: 500, limQ: 3, ops: [{tipo: 'saque', valor: 10.555}], desc: "Consist√™ncia: Garante que a pol√≠tica de arredondamento √© aplicada tanto em entradas quanto em sa√≠das." },
        
        // Grupo 5: Regras de Neg√≥cio
        { id: 't23', name: '23. Limite Saques: Contagem Inicial', bal: 1000, lim: 500, limQ: 3, ops: [{tipo: 'saque', valor: 10}], desc: "Controle de Estado: Verifica se o contador de saques √© incrementado corretamente." },
        { id: 't24', name: '24. Limite Saques: Bloqueio 4¬∫ Saque', bal: 1000, lim: 500, limQ: 3, ops: [{tipo: 'saque', valor: 10}, {tipo: 'saque', valor: 10}, {tipo: 'saque', valor: 10}, {tipo: 'saque', valor: 10}], desc: "Regra de Neg√≥cio (Stateful): Verifica se o sistema bloqueia opera√ß√µes ap√≥s atingir o limite di√°rio." },
        { id: 't25', name: '25. Limite Saques: Dep√≥sito Permitido', bal: 1000, lim: 500, limQ: 3, ops: [{tipo: 'saque', valor: 10}, {tipo: 'saque', valor: 10}, {tipo: 'saque', valor: 10}, {tipo: 'deposito', valor: 100}], desc: "Isolamento de Regras: Garante que o bloqueio de saques n√£o afeta outras opera√ß√µes (dep√≥sitos)." },
        { id: 't26', name: '26. Limite Saques: Customizado (5)', bal: 1000, lim: 500, limQ: 5, ops: [{tipo: 'saque', valor: 10}, {tipo: 'saque', valor: 10}, {tipo: 'saque', valor: 10}, {tipo: 'saque', valor: 10}], desc: "Configura√ß√£o Din√¢mica: Verifica se o limite de saques respeita a configura√ß√£o da inst√¢ncia." },
        { id: 't27', name: '27. L√≥gica: Falha n√£o incrementa', bal: 1000, lim: 500, limQ: 3, ops: [{tipo: 'saque', valor: 2000}, {tipo: 'saque', valor: 10}], desc: "Atomicidade/Rollback: Uma opera√ß√£o falha (ex: saldo insuficiente) N√ÉO deve incrementar o contador de saques realizados." },
        
        // Grupo 6: Bordas e Carga
        { id: 't28', name: '28. Tipos: Decimal Preservado', bal: 0, lim: 500, limQ: 3, ops: [{tipo: 'deposito', valor: 10.5}, {tipo: 'saque', valor: 5}], desc: "Integridade de Tipos: Garante que opera√ß√µes mistas n√£o degradam o tipo Decimal para float." },
        { id: 't29', name: '29. Borda: Dep√≥sito Bilh√£o', bal: 0, lim: 500, limQ: 3, ops: [{tipo: 'deposito', valor: 1000000000}], desc: "Teste de Borda (Overflow): Verifica comportamento com valores muito grandes." },
        { id: 't30', name: '30. Borda: Saque Milh√£o', bal: 0, lim: 2000000, limQ: 3, ops: [{tipo: 'deposito', valor: 2000000}, {tipo: 'saque', valor: 1000000}], desc: "Teste de Carga: Opera√ß√µes de alto valor." },
        { id: 't31', name: '31. Borda: Limite Exato (500)', bal: 1000, lim: 500, limQ: 3, ops: [{tipo: 'saque', valor: 500}], desc: "Teste de Limite (Boundary): Verifica se a condi√ß√£o √© > ou >=." },
        { id: 't32', name: '32. Borda: Acima Limite (500.01)', bal: 1000, lim: 500, limQ: 3, ops: [{tipo: 'saque', valor: 500.01}], desc: "Teste de Limite (Boundary): Verifica se 1 centavo acima do limite √© bloqueado." }
    ];

    // Popular o Select
    const select = document.getElementById('testSelect');
    testCases.forEach(test => {
        const option = document.createElement('option');
        option.value = test.id;
        option.textContent = test.name;
        select.appendChild(option);
    });

    function loadTestScenario() {
        const selectedId = document.getElementById('testSelect').value;
        const test = testCases.find(t => t.id === selectedId);
        
        if (!test) return;

        document.getElementById('initialBalance').value = test.bal;
        document.getElementById('limitValue').value = test.lim;
        document.getElementById('limitQty').value = test.limQ;
        operations = test.ops;
        
        // Atualizar descri√ß√£o TDD
        const descBox = document.getElementById('testDescription');
        const descText = document.getElementById('testDescText');
        if (test.desc) {
            descBox.style.display = 'block';
            descText.textContent = test.desc;
        } else {
            descBox.style.display = 'none';
        }
        
        renderOperations();
    }

    function renderOperations() {
        const container = document.getElementById('operationsList');
        container.innerHTML = '<strong>Opera√ß√µes:</strong><br>' + operations.map((op, index) => 
            `‚Ä¢ ${op.tipo.toUpperCase()} de R$ ${op.valor}`
        ).join('<br>');
    }

    async function runSimulation() {
        const saldoInicial = parseFloat(document.getElementById('initialBalance').value);
        const limite = parseFloat(document.getElementById('limitValue').value);
        const limiteSaque = parseInt(document.getElementById('limitQty').value);

        const payload = {
            saldo_inicial: saldoInicial,
            limite: limite,
            limite_saque: limiteSaque,
            operacoes: operations
        };

        // Limpar resultados
        document.getElementById('tradBalance').innerHTML = 'Carregando...';
        document.getElementById('tddBalance').innerHTML = 'Carregando...';

        try {
            // Executar Tradicional
            const resTrad = await fetch(`${API_BASE_URL}/simulacao/tradicional`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const dataTrad = await resTrad.json();
            updateUI('trad', dataTrad);

            // Executar TDD
            const resTdd = await fetch(`${API_BASE_URL}/simulacao/tdd`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const dataTdd = await resTdd.json();
            updateUI('tdd', dataTdd);

            updateChart(dataTrad.saldo_final, dataTdd.saldo_final);

        } catch (error) {
            alert("Erro ao conectar com a API. Verifique se o servidor est√° rodando (uvicorn api:app --reload).");
            console.error(error);
        }
    }

    function updateUI(prefix, data) {
        const balanceEl = document.getElementById(`${prefix}Balance`);
        const typeEl = document.getElementById(`${prefix}Type`);
        const logEl = document.getElementById(`${prefix}Log`);

        // Formata√ß√£o do Saldo
        let balanceDisplay = data.saldo_final;
        
        // Destacar erro de precis√£o no Tradicional
        if (prefix === 'trad' && data.saldo_final.toString().length > 10) {
            balanceDisplay = `<span class="highlight-error">${data.saldo_final}</span>`;
        } else if (prefix === 'tdd') {
            balanceDisplay = `<span class="highlight-success">${data.saldo_final.toFixed(2)}</span>`;
        }

        balanceEl.innerHTML = `R$ ${balanceDisplay}`;
        typeEl.innerText = data.tipo_dado.replace("<class '", "").replace("'>", "");

        // Hist√≥rico
        logEl.innerHTML = data.historico.map((item, i) => {
            const statusIcon = item.sucesso ? '‚úÖ' : '‚ùå';
            const statusClass = item.sucesso ? 'success' : 'fail';
            
            // L√≥gica para destacar o erro de limite
            let extraInfo = '';
            if (prefix === 'trad' && i === 3 && item.sucesso && item.op === 'saque') {
                extraInfo = '<br><small class="highlight-error">ERRO: Permitiu 4¬∫ saque!</small>';
            }
            if (prefix === 'tdd' && i === 3 && !item.sucesso && item.op === 'saque') {
                extraInfo = '<br><small class="highlight-success">CORRETO: Bloqueou 4¬∫ saque</small>';
            }
            if (prefix === 'tdd' && item.saldo === 0 && !item.sucesso) {
                 extraInfo = '<br><small class="highlight-success">CORRETO: Bloqueou saldo negativo</small>';
            }
            if (prefix === 'tdd' && item.op === 'saque' && !item.sucesso && item.valor > 500 && item.valor <= 2000) {
                 extraInfo = '<br><small class="highlight-success">CORRETO: Bloqueou limite valor</small>';
            }

            return `
                <div class="log-item ${statusClass}">
                    <span>${i+1}. ${item.op} R$${item.valor}</span>
                    <span style="text-align:right">${statusIcon} Saldo: ${item.saldo}${extraInfo}</span>
                </div>
            `;
        }).join('');
    }

    function updateChart(tradBalance, tddBalance) {
        const ctx = document.getElementById('balanceChart').getContext('2d');
        
        if (chartInstance) {
            chartInstance.destroy();
        }

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Tradicional (Float)', 'TDD (Decimal)'],
                datasets: [{
                    label: 'Saldo Final (R$)',
                    data: [tradBalance, tddBalance],
                    backgroundColor: [
                        'rgba(231, 76, 60, 0.7)', // Vermelho para Tradicional
                        'rgba(46, 204, 113, 0.7)'  // Verde para TDD
                    ],
                    borderColor: [
                        'rgba(231, 76, 60, 1)',
                        'rgba(46, 204, 113, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: false } // Come√ßa pr√≥ximo aos valores para destacar diferen√ßas pequenas
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.raw; // Mostra o valor exato (com casas decimais extras se houver)
                            }
                        }
                    }
                }
            }
        });
    }

    // Inicializar vazio
    // setScenario('precision');

    function toggleStructure() {
        const content = document.getElementById('structureContent');
        const icon = document.getElementById('toggleIcon');
        if (content.style.display === 'none') {
            content.style.display = 'block';
            icon.textContent = '‚ñ≤';
        } else {
            content.style.display = 'none';
            icon.textContent = '‚ñº';
        }
    }
</script>

</body>
